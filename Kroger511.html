<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPH, TECH & LICENSE List</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  .expired { background-color: #f8d7da; }    /* red */
  .warning { background-color: #fff3cd; }    /* yellow */
  .valid { background-color: #d4edda; }      /* green */
  button { margin: 2px; }
</style>
</head>
<body>
<h2>RPH, TECH & LICENSE List</h2>

<div id="formSection">
  <label>
    Role:
    <select id="role">
      <option value="RPH">RPH</option>
      <option value="TECH">TECH</option>
      <option value="LICENSE">LICENSE</option>
    </select>
  </label>
  <label>Name: <input type="text" id="name"></label>
  <label>License Expiration: <input type="date" id="licenseDate"></label>
  <label>CPR Expiration: <input type="date" id="cprDate"></label>
  <button onclick="addOrUpdateEntry()">Save</button>
</div>

<div style="margin-top:10px;">
  <button onclick="exportList()">Export List</button>
  <input type="file" id="fileInput" accept=".txt" onchange="importListFromFile(event)">
  <button onclick="loadFromGitHub()">Load from GitHub</button>
  <input type="password" id="ghToken" placeholder="GitHub Token">
  <button onclick="saveToGitHub()">Save to GitHub</button>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>Role</th>
      <th>Name</th>
      <th>License Expiration</th>
      <th>CPR Expiration</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let entries = [];
let editingIndex = null;
const githubUser = "htdhtdhtd2003";
const githubRepo = "ndc";
const githubPath = "rph_tech_list1.txt";

// Normalize dates to YYYY-MM-DD
function normalizeDates(entry) {
  const normalize = (d) => {
    if(!d) return "";
    const [y,m,day] = d.split("-");
    return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${day.padStart(2,'0')}`;
  };
  return {...entry, licenseDate: normalize(entry.licenseDate), cprDate: normalize(entry.cprDate)};
}

// Highlight expired/warning/valid dates
function highlightDate(dateStr){
  if(!dateStr) return '';
  const today = new Date(); today.setHours(0,0,0,0);
  const [y,m,d] = dateStr.split("-");
  const date = new Date(y,m-1,d);
  const diff = (date-today)/(1000*60*60*24);
  if(date<today) return "expired";
  if(diff<=30) return "warning";
  return "valid";
}

// Format YYYY-MM-DD to MM/DD/YYYY
function formatDate(dateStr){
  if(!dateStr) return "";
  const [y,m,d] = dateStr.split("-");
  return `${m.padStart(2,'0')}/${d.padStart(2,'0')}/${y}`;
}

// Copy text reliably
function copyTextFallback(text){
  const textarea = document.createElement("textarea");
  textarea.value = text;
  document.body.appendChild(textarea);
  textarea.select();
  try{ document.execCommand("copy"); } catch(e){ alert("Copy failed"); }
  document.body.removeChild(textarea);
}

async function copyText(text){
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).catch(()=>copyTextFallback(text));
  } else {
    copyTextFallback(text);
  }
}

// Render table
function renderTable(){
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML="";
  entries.forEach((e,i)=>{
    const tr = document.createElement("tr");
    const licenseClass = highlightDate(e.licenseDate);
    const cprClass = e.cprDate?highlightDate(e.cprDate):"";
    tr.innerHTML=`
      <td>${e.role}</td>
      <td>${e.name} <button class="copy-btn" data-copy="${e.name}" data-type="text">Copy</button></td>
      <td class="${licenseClass}">${formatDate(e.licenseDate)} <button class="copy-btn" data-copy="${e.licenseDate}" data-type="date">Copy</button></td>
      <td class="${cprClass}">${e.cprDate?formatDate(e.cprDate)+' <button class="copy-btn" data-copy="'+e.cprDate+'" data-type="date">Copy</button>':""}</td>
      <td>
        <button onclick="editEntry(${i})">Edit</button>
        <button onclick="deleteEntry(${i})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  document.querySelectorAll(".copy-btn").forEach(btn=>{
    btn.onclick=()=>{
      const val=btn.getAttribute("data-copy");
      const type=btn.getAttribute("data-type");
      copyText(type==="date"?formatDate(val):val);
    };
  });
}

// Sort entries
function sortEntries(){
  const roleOrder={LICENSE:1,RPH:2,TECH:3};
  entries.sort((a,b)=>{
    const r=roleOrder[a.role]-roleOrder[b.role];
    if(r!==0) return r;
    const n=a.name.localeCompare(b.name);
    if(n!==0) return n;
    return new Date(a.licenseDate)-new Date(b.licenseDate);
  });
}

// Add/Edit/Delete
function addOrUpdateEntry(){
  const role=document.getElementById("role").value;
  const name=document.getElementById("name").value.trim();
  const licenseDate=document.getElementById("licenseDate").value;
  const cprDate=document.getElementById("cprDate").value;
  if(!name || !licenseDate){ alert("Name and License required"); return; }
  if(role==="RPH" && !cprDate){ alert("CPR required for RPH"); return; }
  const entry=normalizeDates({id:editingIndex!==null?entries[editingIndex].id:Date.now(),role,name,licenseDate,cprDate:role==="LICENSE"? "": cprDate});
  if(editingIndex!==null){ entries[editingIndex]=entry; editingIndex=null; }
  else entries.push(entry);
  sortEntries(); renderTable(); saveLocal(); clearForm();
}

function editEntry(i){ const e=entries[i]; document.getElementById("role").value=e.role; document.getElementById("name").value=e.name; document.getElementById("licenseDate").value=e.licenseDate; document.getElementById("cprDate").value=e.cprDate||""; editingIndex=i; }
function deleteEntry(i){ if(confirm("Delete this entry?")){ entries.splice(i,1); renderTable(); saveLocal(); } }
function clearForm(){ document.getElementById("name").value=""; document.getElementById("licenseDate").value=""; document.getElementById("cprDate").value=""; document.getElementById("role").value="RPH"; }

// Local storage
function saveLocal(){ localStorage.setItem("rphTechList",JSON.stringify(entries)); }
function loadLocal(){ const data=localStorage.getItem("rphTechList"); if(data) entries=JSON.parse(data); }

// File import/export
function exportList(){ const blob=new Blob([JSON.stringify(entries,null,2)],{type:"text/plain"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="rph_tech_list.txt"; a.click(); }
function importListFromFile(event){ entries=[]; const file=event.target.files[0]; const reader=new FileReader(); reader.onload=function(e){ try{ const data=JSON.parse(e.target.result); if(Array.isArray(data)) entries=data.map(normalizeDates); sortEntries(); renderTable(); saveLocal(); } catch{ alert("Invalid file"); } }; reader.readAsText(file); }

// GitHub load/save
async function loadFromGitHub(){
  entries=[];
  try{
    const res=await fetch(`https://raw.githubusercontent.com/${githubUser}/${githubRepo}/main/${githubPath}`);
    if(!res.ok) throw new Error("GitHub fetch failed");
    const data = await res.json();  // plain JSON
    entries = data.map(normalizeDates);
    sortEntries();
    renderTable();
    saveLocal();
  } catch(err){ alert("Error loading from GitHub: "+err.message); }
}

async function saveToGitHub(){
  const token=document.getElementById("ghToken").value.trim();
  if(!token){ alert("GitHub token required"); return; }
  try{
    const getRes=await fetch(`https://api.github.com/repos/${githubUser}/${githubRepo}/contents/${githubPath}`,{headers:{Authorization:"token "+token}});
    const fileData=await getRes.json();
    const sha=fileData.sha;
    const body={message:"Update list", content:btoa(unescape(encodeURIComponent(JSON.stringify(entries,null,2)))), sha};
    const putRes=await fetch(`https://api.github.com/repos/${githubUser}/${githubRepo}/contents/${githubPath}`,{method:"PUT", headers:{Authorization:"token "+token,"Content-Type":"application/json"}, body:JSON.stringify(body)});
    if(putRes.ok) alert("Saved to GitHub"); else alert("Failed to save");
  } catch(err){ alert("Error saving to GitHub: "+err.message); }
}

// Init
loadLocal(); sortEntries(); renderTable();
</script>
</body>
</html>
