<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RPH/Tech List Manager</title>
<style>
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #aaa; padding: 5px; text-align: left; }
  .red { background-color: #f8b3b3; }
  .yellow { background-color: #fff3b0; }
  .green { background-color: #b3f8b3; }
</style>
</head>
<body>
<h2>RPH/Tech List Manager</h2>

<select id="role">
  <option value="RPH">RPH</option>
  <option value="TECH">TECH</option>
</select>
<input type="text" id="name" placeholder="Name">
<input type="date" id="licenseDate" placeholder="License Exp">
<input type="date" id="cprDate" placeholder="CPR Exp (RPH only)">
<button onclick="addEntry()">Add</button>

<hr>

<button onclick="saveToGitHub()">Save to GitHub</button>
<button onclick="loadFromGitHub()">Load from GitHub</button>
<input type="file" id="fileInput" accept=".txt" onchange="importFromFile(event)">
<button onclick="exportToFile()">Export File</button>

<table id="entryTable">
  <thead>
    <tr>
      <th>Role</th>
      <th>Name</th>
      <th>License Exp</th>
      <th>CPR Exp</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let entries = [];
const repoOwner = "htdhtdhtd2003";
const repoName = "ndc";
const filePath = "rph_tech_list.txt";
let githubToken = ""; // set your token here if needed

function formatDate(d){
  if(!d) return "";
  const dt = new Date(d);
  if(isNaN(dt)) return "";
  return dt.toLocaleDateString("en-US", {year:"numeric", month:"2-digit", day:"2-digit"});
}

function addEntry(){
  const role = document.getElementById("role").value;
  const name = document.getElementById("name").value.trim();
  const licenseDate = document.getElementById("licenseDate").value;
  const cprDate = role==="RPH"?document.getElementById("cprDate").value:"";
  if(!name || !licenseDate) return alert("Name and License Exp required");
  entries.push({role,name,licenseDate,cprDate});
  renderTable();
}

function renderTable(){
  const tbody = document.querySelector("#entryTable tbody");
  tbody.innerHTML = "";
  const today = new Date();
  const oneMonth = 30*24*60*60*1000;

  entries.forEach((e,idx)=>{
    const licenseDiff = new Date(e.licenseDate)-today;
    const cprDiff = e.cprDate?new Date(e.cprDate)-today:null;
    let licenseClass = licenseDiff<0?'red':licenseDiff<=oneMonth?'yellow':'green';
    let cprClass = cprDiff===null?'':cprDiff<0?'red':cprDiff<=oneMonth?'yellow':'green';

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.role}</td>
      <td>${e.name} <button onclick="copyToClipboard('${e.name}')">Copy</button></td>
      <td class="${licenseClass}">${formatDate(e.licenseDate)} <button onclick="copyToClipboard('${formatDate(e.licenseDate)}')">Copy</button></td>
      <td class="${cprClass}">${e.cprDate?formatDate(e.cprDate):""} ${e.cprDate?`<button onclick="copyToClipboard('${formatDate(e.cprDate)}')">Copy</button>`:""}</td>
      <td>
        <button onclick="copyRowAll(${idx})">Copy All</button>
        <button onclick="deleteEntry(${idx})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function deleteEntry(index){
  if(confirm("Delete this entry?")){
    entries.splice(index,1);
    renderTable();
  }
}

function copyToClipboard(text){
  if(text && text!=="N/A"){
    navigator.clipboard.writeText(text);
  }
}

// Copy all with 5-second spacing
async function copyRowAll(index){
  const e = entries[index];
  const items = [];
  if(e.name) items.push(e.name);
  if(e.licenseDate) items.push(formatDate(e.licenseDate));
  if(e.cprDate) items.push(formatDate(e.cprDate));

  for(let i=0;i<items.length;i++){
    await navigator.clipboard.writeText(items[i]);
    if(i<items.length-1) await new Promise(r=>setTimeout(r,5000));
  }
}

// Local export
function exportToFile(){
  const blob = new Blob([JSON.stringify(entries)], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "rph_tech_list.txt";
  a.click();
}

// Local import
function importFromFile(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      if(Array.isArray(data)){
        entries = data;
        renderTable();
      }
    }catch(err){ alert("Invalid file"); }
  };
  reader.readAsText(file);
}

// GitHub Load
async function loadFromGitHub(){
  try{
    // clear table before load
    entries = [];
    renderTable();
    const url = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${filePath}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("Fetch failed");
    const text = await res.text();
    const data = JSON.parse(text);
    if(Array.isArray(data)) entries = data;
    renderTable();
  }catch(err){ alert("Error loading from GitHub: "+err.message); }
}

// GitHub Save
async function saveToGitHub(){
  if(!githubToken) return alert("GitHub token required");
  const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
  try{
    const getRes = await fetch(url,{headers:{Authorization:`token ${githubToken}`}});
    const getData = await getRes.json();
    const sha = getData.sha;
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(entries))));
    const body = {message:"Update rph_tech_list", content, sha};
    const putRes = await fetch(url,{
      method:"PUT",
      headers:{Authorization:`token ${githubToken}`, "Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    if(putRes.ok) alert("Saved to GitHub"); else alert("Failed to save");
  }catch(err){ alert("Error saving: "+err.message); }
}
</script>
</body>
</html>
