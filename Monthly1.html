<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPH/Tech Manager</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  label { display: block; margin: 5px 0 2px; }
  input, select, button { margin-bottom: 10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f4f4f4; cursor: pointer; }
  .red { background-color: #f88; }
  .yellow { background-color: #ffeb99; }
  .green { background-color: #8f8; }
</style>
</head>
<body>

<h2>RPH / TECH Manager</h2>

<label for="token">Enter GitHub Token (optional, required only for saving)</label>
<input type="password" id="token" placeholder="GitHub token">

<button onclick="loadFromGitHub()">Load from GitHub</button>
<button onclick="saveToGitHub()">Save to GitHub</button>

<label for="role">Select Role:</label>
<select id="role">
  <option value="">--Select--</option>
  <option value="RPH">RPH</option>
  <option value="TECH">TECH</option>
</select>

<div id="formContainer"></div>

<button onclick="addEntry()">Add Entry</button>
<button onclick="exportList()">Export List</button>
<input type="file" id="importFile" onchange="importList(event)">
<button onclick="clearAll()">Clear All</button>

<label for="filterRole">Filter by Role:</label>
<select id="filterRole" onchange="renderTable()">
  <option value="ALL">All</option>
  <option value="RPH">RPH</option>
  <option value="TECH">TECH</option>
</select>

<table id="entryTable">
  <thead>
    <tr>
      <th onclick="sortTable('role')">Role</th>
      <th onclick="sortTable('name')">Name</th>
      <th onclick="sortTable('licenseDate')">License Expiration</th>
      <th onclick="sortTable('cprDate')">CPR Expiration</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let entries = JSON.parse(localStorage.getItem('entries')) || [];
let editIndex = null;
let sortConfig = { key: null, asc: true };

// GitHub repo details
const repoOwner = "htdhtdhtd2003";
const repoName = "htdhtdhtd2003.github.io";
const filePath = "ndc/rph_tech_list.txt";

document.getElementById('role').addEventListener('change', renderForm);

function renderForm() {
    const role = document.getElementById('role').value;
    const container = document.getElementById('formContainer');
    container.innerHTML = '';
    if(!role) return;

    const todayStr = new Date().toISOString().split('T')[0];

    container.innerHTML += `<label>Name:</label><input type="text" id="name">`;
    container.innerHTML += `<label>License Expiration:</label><input type="date" id="licenseDate" min="${todayStr}">`;
    if(role === 'RPH') container.innerHTML += `<label>CPR Expiration:</label><input type="date" id="cprDate" min="${todayStr}">`;
}

function addEntry() {
    const role = document.getElementById('role').value;
    const name = document.getElementById('name')?.value;
    const licenseDate = document.getElementById('licenseDate')?.value;
    const cprDate = document.getElementById('cprDate')?.value || '';

    if(!role || !name || !licenseDate || (role === 'RPH' && !cprDate)) {
        alert('Please fill all required fields.');
        return;
    }

    const entry = { role, name, licenseDate, cprDate };
    if(editIndex !== null) { entries[editIndex] = entry; editIndex = null; } 
    else { entries.push(entry); }

    saveAndRender();
}

function formatDate(dateStr) {
    if(!dateStr) return '';
    const d = new Date(dateStr);
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${mm}/${dd}/${yyyy}`;
}

function renderTable() {
    const tbody = document.querySelector('#entryTable tbody');
    tbody.innerHTML = '';
    const today = new Date();
    const oneMonth = 30*24*60*60*1000;
    const filter = document.getElementById('filterRole').value;

    let displayEntries = [...entries];
    if(filter !== 'ALL') displayEntries = displayEntries.filter(e=>e.role===filter);

    if(sortConfig.key) {
        displayEntries.sort((a,b)=>{
            let valA = a[sortConfig.key]||'';
            let valB = b[sortConfig.key]||'';
            if(sortConfig.key.includes('Date')) { valA = valA||'9999-12-31'; valB = valB||'9999-12-31'; }
            return sortConfig.asc?(valA>valB?1:-1):(valA<valB?1:-1);
        });
    }

    displayEntries.forEach(e=>{
        const licenseDiff = new Date(e.licenseDate)-today;
        const cprDiff = e.cprDate?new Date(e.cprDate)-today:null;
        let licenseClass = licenseDiff<0?'red':licenseDiff<=oneMonth?'yellow':'green';
        let cprClass = cprDiff===null?'':cprDiff<0?'red':cprDiff<=oneMonth?'yellow':'green';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${e.role}</td>
            <td>${e.name} <button onclick="copyToClipboard('${e.name}')">Copy</button></td>
            <td class="${licenseClass}">${formatDate(e.licenseDate)} <button onclick="copyToClipboard('${formatDate(e.licenseDate)}')">Copy</button></td>
            <td class="${cprClass}">${e.cprDate?formatDate(e.cprDate):''} ${e.cprDate?`<button onclick="copyToClipboard('${formatDate(e.cprDate)}')">Copy</button>`:''}</td>
            <td>
                <button onclick="editEntry(${entries.indexOf(e)})">Edit</button>
                <button onclick="deleteEntry(${entries.indexOf(e)})">Delete</button>
            </td>`;
        tbody.appendChild(tr);
    });
}

function copyToClipboard(text){ navigator.clipboard.writeText(text); }
function sortTable(key){ sortConfig.key===key?sortConfig.asc=!sortConfig.asc:sortConfig={key:key,asc:true}; renderTable(); }
function editEntry(index){ 
    const e = entries[index]; 
    document.getElementById('role').value = e.role; renderForm(); 
    document.getElementById('name').value = e.name; 
    document.getElementById('licenseDate').value = e.licenseDate; 
    if(e.role==='RPH') document.getElementById('cprDate').value = e.cprDate;
    editIndex=index; 
}
function deleteEntry(index){ if(confirm('Delete this entry?')){ entries.splice(index,1); saveAndRender(); } }
function saveAndRender(){ localStorage.setItem('entries',JSON.stringify(entries)); renderTable(); clearForm(); }
function clearForm(){ document.getElementById('role').value=''; document.getElementById('formContainer').innerHTML=''; }
function exportList(){ const blob = new Blob([JSON.stringify(entries,null,2)],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rph_tech_list.txt'; a.click(); }
function importList(e){ const file=e.target.files[0]; const reader=new FileReader(); reader.onload=function(e){ try{ entries=JSON.parse(e.target.result); localStorage.setItem('entries',JSON.stringify(entries)); renderTable(); } catch(err){ alert('Invalid file'); } }; reader.readAsText(file);}
function clearAll(){ if(confirm('Clear all entries?')){ entries=[]; localStorage.removeItem('entries'); renderTable(); } }

// --- GitHub integration ---
async function loadFromGitHub(){
    const url=`https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${filePath}`;
    try{
        const res=await fetch(url);
        if(!res.ok) return alert('Failed to load from GitHub');
        const text=await res.text();
        entries=JSON.parse(text);
        localStorage.setItem('entries',JSON.stringify(entries));
        renderTable();
        alert('Loaded from GitHub');
    }catch(err){ alert('Error loading GitHub file'); }
}

async function saveToGitHub(){
    const token=document.getElementById('token').value.trim();
    if(!token) return alert('Token required to save');
    const url=`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
    try{
        const getRes=await fetch(url,{headers:{Authorization:`token ${token}`}});
        const data=await getRes.json();
        const sha=data.sha;
        const body={message:'Update rph_tech_list.txt', content:btoa(JSON.stringify(entries,null,2)), sha:sha};
        const putRes=await fetch(url,{method:'PUT', headers:{Authorization:`token ${token}`,Accept:'application/vnd.github.v3+json'}, body:JSON.stringify(body)});
        if(putRes.ok) alert('Saved to GitHub'); else alert('Failed to save to GitHub');
    }catch(err){ alert('Error saving to GitHub'); }
}

// Initial render
renderTable();
</script>
</body>
</html>
