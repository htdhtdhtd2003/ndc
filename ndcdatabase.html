<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drug Location Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f4f4f9;
        color: #333;
    }
    input, button {
        padding: 8px;
        margin: 5px;
        font-size: 16px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    th, td {
        border: 1px solid #aaa;
        padding: 8px;
        text-align: center;
    }
    tr.selected {
        background-color: #d3f4ff;
    }
    .qr-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
</style>
</head>
<body>

<h2>Drug Location Tracker</h2>

<div>
    <label>11-digit NDC:</label>
    <input type="text" id="ndcInput" maxlength="11" placeholder="Scan 11-digit NDC">

    <label>13-digit UPC:</label>
    <input type="text" id="upcInput" maxlength="13" placeholder="Scan 13-digit UPC">

    <label>Section:</label>
    <input list="sectionList" id="section" placeholder="Enter or select Section">
    <datalist id="sectionList"></datalist>

    <label>Column:</label>
    <input list="columnList" id="column" placeholder="Enter or select Column">
    <datalist id="columnList"></datalist>

    <label>Color:</label>
    <input list="colorList" id="color" placeholder="Enter or select Color">
    <datalist id="colorList"></datalist>

    <button id="setLocation">Set Location</button>
    <button id="saveFile">Save Backup</button>
    <input type="file" id="openFile" style="display:none">
    <button onclick="document.getElementById('openFile').click()">Open Backup</button>
</div>

<table id="drugTable">
    <thead>
        <tr>
            <th>NDC/UPC</th>
            <th>Section</th>
            <th>Column</th>
            <th>Color</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="qr-container">
    <div>
        <h3>Drug QR Code</h3>
        <canvas id="qrDrug"></canvas>
    </div>
    <div>
        <h3>Location QR Code</h3>
        <canvas id="qrLocation"></canvas>
    </div>
</div>

<script>
// --- Suppress F1 to F14 ---
document.addEventListener('keydown', function(e) {
    if(e.key.startsWith('F') && parseInt(e.key.substring(1)) >= 1 && parseInt(e.key.substring(1)) <= 14) {
        e.preventDefault();
    }
});

let currentLocation = { section: '', column: '', color: '' };

// --- Load last location from localStorage ---
window.onload = function() {
    const savedLocation = JSON.parse(localStorage.getItem('lastLocation'));
    if (savedLocation) {
        currentLocation = savedLocation;
        document.getElementById('section').value = savedLocation.section;
        document.getElementById('column').value = savedLocation.column;
        document.getElementById('color').value = savedLocation.color;
    }
    document.getElementById('ndcInput').focus();
};

// --- Set location ---
document.getElementById('setLocation').addEventListener('click', () => {
    setLocationFromInputs();
});

// --- Automatic scan save for NDC (11 digits) ---
document.getElementById('ndcInput').addEventListener('input', function() {
    if(this.value.length === 11) {
        saveCodeToTable(this.value);
        this.value = '';
        this.focus();
    }
});

// --- Automatic scan save for UPC (13 digits) ---
document.getElementById('upcInput').addEventListener('input', function() {
    if(this.value.length === 13) {
        saveCodeToTable(this.value);
        this.value = '';
        this.focus();
    }
});

// --- Save code to table ---
function saveCodeToTable(code) {
    if (!currentLocation.section || !currentLocation.column || !currentLocation.color) {
        alert('Please set the location first!');
        return;
    }
    let tbody = document.getElementById('drugTable').querySelector('tbody');
    let tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${code}</td>
        <td>${currentLocation.section}</td>
        <td>${currentLocation.column}</td>
        <td>${currentLocation.color}</td>
    `;
    tr.addEventListener('click', () => {
        document.querySelectorAll('#drugTable tr').forEach(r => r.classList.remove('selected'));
        tr.classList.add('selected');
        generateQRCode('qrDrug', code);
        generateQRCode('qrLocation', `${currentLocation.section}-${currentLocation.column}-${currentLocation.color}`);
    });
    tbody.appendChild(tr);
}

// --- Generate QR code ---
function generateQRCode(canvasId, text) {
    QRCode.toCanvas(document.getElementById(canvasId), text, { width: 150 }, function (error) {
        if (error) console.error(error);
    });
}

// --- Set location from input fields ---
function setLocationFromInputs() {
    const section = document.getElementById('section').value.trim();
    const column = document.getElementById('column').value.trim();
    const color = document.getElementById('color').value.trim();

    if(!section || !column || !color) {
        alert('Please enter Section, Column, and Color.');
        return;
    }

    currentLocation = { section, column, color };
    localStorage.setItem('lastLocation', JSON.stringify(currentLocation)); // Save to localStorage

    // Add to datalists for autocomplete
    addToDatalist('sectionList', section);
    addToDatalist('columnList', column);
    addToDatalist('colorList', color);

    alert('Location set! Now scanning will use this location.');
    document.getElementById('ndcInput').focus();
}

// --- Add value to datalist for autocomplete ---
function addToDatalist(listId, value) {
    const datalist = document.getElementById(listId);
    if (![...datalist.options].some(opt => opt.value === value)) {
        const option = document.createElement('option');
        option.value = value;
        datalist.appendChild(option);
    }
}

// --- Save table to file ---
document.getElementById('saveFile').addEventListener('click', () => {
    const tbody = document.getElementById('drugTable').querySelector('tbody');
    const data = [...tbody.rows].map(row => ({
        code: row.cells[0].innerText,
        section: row.cells[1].innerText,
        column: row.cells[2].innerText,
        color: row.cells[3].innerText
    }));
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'drug_backup.json';
    a.click();
    URL.revokeObjectURL(url);
});

// --- Open backup file ---
document.getElementById('openFile').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            const tbody = document.getElementById('drugTable').querySelector('tbody');
            tbody.innerHTML = '';
            data.forEach(item => saveCodeToTable(item.code));
        } catch(err) {
            alert('Invalid file format');
        }
    }
    reader.readAsText(file);
});
</script>

</body>
</html>
