<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drug Scanner + GitHub Save + Camera</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; background: #0e1726; color: #e8ecf5; margin: 0; padding: 18px; }
  h1 { margin-top:0; font-size:20px; }
  .card { background: rgba(255,255,255,0.05); padding:12px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.2); margin-bottom:12px; }
  label { font-size:13px; color:#aab3c0; }
  input, button { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: inherit; }
  button { cursor:pointer; }
  table { width:100%; border-collapse: collapse; margin-top:12px; }
  th, td { padding:6px 8px; border-bottom:1px solid rgba(255,255,255,0.05); }
  th { color:#99a2b0; text-align:left; }
  .swatch { width:28px; height:18px; border-radius:4px; }
  .active-location { background:#1a2333; border:1px solid #334155; padding:10px; border-radius:8px; margin-top:10px; }
  .active-location strong { color:#38bdf8; }
  video { width:100%; border-radius:8px; display:none; margin-top:10px; }
  #torchBtn { display:none; margin-top:8px; }
</style>
</head>
<body>
<h1>Drug Location Scanner</h1>

<div class="card">
  <label>Section #</label>
  <input id="section" type="number" min="1" value="1">
  <label>Column #</label>
  <input id="column" type="number" min="1" value="1">
  <label>Color</label>
  <input id="color" type="color" value="#60a5fa">
  <button id="setLocationBtn">Set Location</button>

  <div id="activeLocation" class="active-location" style="display:none;">
    <strong>Active Location:</strong>
    <span id="locLabel"></span>
    <button id="changeLocationBtn">Change</button>
    <button id="stopScanBtn">Stop</button>
  </div>
  <p id="status">Waiting for scan...</p>
</div>

<div class="card">
  <label>Scan or Type UPC/NDC:</label><br>
  <input id="scanInput" type="text" placeholder="Scan or type code" autofocus>
  <button id="startCamera">üì∑ Start Camera Scanner</button>
  <button id="torchBtn">üí° Toggle Flashlight</button>
  <video id="preview" autoplay muted playsinline></video>
</div>

<div class="card">
  <button id="saveGitHubBtn">Save to GitHub</button>
  <button id="lockDbBtn">Lock Database</button>
</div>

<table id="logTable">
  <thead>
    <tr><th>#</th><th>Code</th><th>Type</th><th>Section</th><th>Column</th><th>Color</th><th>Time</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const githubDB = "https://htdhtdhtd2003.github.io/ndc/database.json";
let githubData = [];
let localData = JSON.parse(localStorage.getItem('drug_location_db') || '[]');
let currentLocation = null;
let githubToken = null;
let cameraActive = false;
let codeReader = null;
let track = null;
let torchOn = false;

// Load GitHub DB
async function loadGitHub() {
  try {
    const res = await fetch(githubDB + '?t=' + Date.now());
    githubData = await res.json();
    console.log('GitHub DB loaded:', githubData.length);
  } catch(err){ console.error(err); }
}
loadGitHub();
setInterval(loadGitHub, 3*60*1000);

// Save local
function saveLocalDB(){ localStorage.setItem('drug_location_db', JSON.stringify(localData)); }

// Render table
function renderTable(){
  const body = document.querySelector('#logTable tbody');
  body.innerHTML='';
  localData.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${it.code}</td><td>${it.type}</td><td>${it.section}</td><td>${it.column}</td><td><div class="swatch" style="background:${it.color}"></div></td><td>${new Date(it.time).toLocaleTimeString()}</td>`;
    body.appendChild(tr);
  });
}
renderTable();

function classify(code){
  const num=code.replace(/\D/g,'');
  if(/^\d{12}$/.test(num))return'UPC';
  if(/^\d{10,11}$/.test(num))return'NDC';
  return 'UNKNOWN';
}

function speak(text){
  if(!('speechSynthesis' in window))return;
  const u=new SpeechSynthesisUtterance(text);
  u.rate=1; u.pitch=1;
  window.speechSynthesis.speak(u);
}

function getColorName(hex){
  const map={"#60a5fa":"Blue","#f87171":"Red","#34d399":"Green","#fbbf24":"Yellow","#a78bfa":"Purple","#f472b6":"Pink","#facc15":"Gold","#10b981":"Teal"};
  return map[hex.toLowerCase()]||"Unknown";
}

function addOrUpdate(code){
  const input=document.getElementById('scanInput');
  if(!currentLocation){
    document.getElementById('status').textContent='‚ö†Ô∏è Set location first.';
    input.value=''; input.focus(); return;
  }
  const existing=localData.find(it=>it.code===code);
  if(existing){
    const move=confirm(`Code ${code} already exists.\nMove to new location?`);
    if(move){
      existing.section=currentLocation.section;
      existing.column=currentLocation.column;
      existing.color=currentLocation.color;
      existing.time=Date.now();
      document.getElementById('status').textContent=`‚úÖ Moved ${code}.`;
    } else document.getElementById('status').textContent=`‚è© Duplicate ignored.`;
  } else{
    localData.push({
      code, type: classify(code), section: currentLocation.section,
      column: currentLocation.column, color: currentLocation.color, time: Date.now()
    });
    document.getElementById('status').textContent=`Added ${code} at Section ${currentLocation.section}, Column ${currentLocation.column}`;
  }
  saveLocalDB(); renderTable();
  speak(`Drug found at Section ${currentLocation.section}, Column ${currentLocation.column}, Color ${getColorName(currentLocation.color)}`);
  input.value=''; input.focus();
}

// Location buttons
document.getElementById('setLocationBtn').onclick=()=>{
  const s=document.getElementById('section').value;
  const c=document.getElementById('column').value;
  const color=document.getElementById('color').value;
  currentLocation={section:s,column:c,color};
  document.getElementById('activeLocation').style.display='block';
  document.getElementById('locLabel').textContent=`Section ${s}, Column ${c}`;
  document.getElementById('status').textContent='Ready to scan.';
  document.getElementById('scanInput').focus();
};
document.getElementById('changeLocationBtn').onclick=()=>{
  currentLocation=null;
  document.getElementById('activeLocation').style.display='none';
  document.getElementById('status').textContent='Location cleared.';
  document.getElementById('scanInput').focus();
};
document.getElementById('stopScanBtn').onclick=()=>{
  currentLocation=null;
  document.getElementById('status').textContent='Scanning stopped.';
  document.getElementById('scanInput').focus();
};

// Scan input
document.getElementById('scanInput').addEventListener('keypress', e=>{
  if(e.key==='Enter'){ e.preventDefault(); const code=e.target.value.trim(); if(code) addOrUpdate(code);}
});

// GitHub save with token validation
document.getElementById('saveGitHubBtn').onclick = async () => {
  const status = document.getElementById('status');
  if (!githubToken) {
    githubToken = prompt("Enter GitHub Personal Access Token (with repo permissions):");
    if (!githubToken) return alert("Token required.");
  }

  status.textContent = "üîÑ Validating token...";
  if (!(await validateToken(githubToken))) {
    alert("‚ùå Invalid GitHub token or expired token.");
    githubToken = null;
    status.textContent = "‚ùå Token invalid.";
    return;
  }

  status.textContent = "‚è≥ Saving to GitHub...";
  await saveToGitHub(githubToken);
  status.textContent = "‚úÖ GitHub database updated.";
  document.getElementById('scanInput').focus();
};

document.getElementById('lockDbBtn').onclick=()=>{
  githubToken=null;
  alert("‚úÖ Database locked. GitHub token cleared.");
};

// Validate GitHub token
async function validateToken(token){
  try{
    const res = await fetch("https://api.github.com/user", { headers:{Authorization:`token ${token}`} });
    return res.ok;
  } catch { return false; }
}

// GitHub upload
async function saveToGitHub(token){
  const owner = "htdhtdhtd2003";
  const repo = "ndc";
  const path = "database.json";
  const branch = "main";

  try {
    let sha = null;
    const getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
      headers: { Authorization: `token ${token}` }
    });

    if (getRes.status === 404) {
      console.warn("database.json not found ‚Äî creating new file.");
    } else if (getRes.ok) {
      const data = await getRes.json();
      sha = data.sha;
    }

    const updatedContent = btoa(JSON.stringify(localData, null, 2));
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: "PUT",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Update database.json via Drug Scanner",
        content: updatedContent,
        sha,
        branch
      })
    });

    const result = await res.json();
    if (!res.ok) alert(`‚ùå Save failed: ${result.message || "Unknown error"}`);
    else alert("‚úÖ database.json saved successfully!");
  } catch (err) {
    console.error("GitHub save error:", err);
    alert("‚ùå GitHub API error. Check console for details.");
  }
}

// --- üì∑ CAMERA BARCODE SCANNER (fixed version) ---
document.getElementById('startCamera').onclick = async () => {
  const video = document.getElementById('preview');
  const torchBtn = document.getElementById('torchBtn');

  if (cameraActive) {
    codeReader?.reset();
    track?.stop();
    torchBtn.style.display = 'none';
    video.style.display = 'none';
    document.getElementById('startCamera').textContent = 'üì∑ Start Camera Scanner';
    cameraActive = false;
    return;
  }

  document.getElementById('status').textContent = "üîç Requesting camera access...";
  try {
    await navigator.mediaDevices.getUserMedia({ video: true });

    const { BrowserMultiFormatReader } = await import("https://unpkg.com/@zxing/browser@latest");
    codeReader = new BrowserMultiFormatReader();
    const devices = await BrowserMultiFormatReader.listVideoInputDevices();
    const backCam = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
    if (!backCam) throw new Error("No camera found");

    const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: backCam.deviceId, facingMode: "environment" } });
    video.srcObject = stream;
    track = stream.getVideoTracks()[0];
    video.style.display = 'block';
    torchBtn.style.display = 'inline-block';
    cameraActive = true;
    document.getElementById('startCamera').textContent = 'üõë Stop Camera Scanner';
    document.getElementById('status').textContent = "üì∏ Camera active. Aim at barcode.";

    codeReader.decodeFromVideoDevice(backCam.deviceId, 'preview', (result, err) => {
      if (result) addOrUpdate(result.text);
    });

  } catch (err) {
    console.error("Camera start error:", err);
    document.getElementById('status').textContent = "‚ùå Camera failed to start. Check HTTPS or permissions.";
  }
};

// üí° Flashlight toggle
document.getElementById('torchBtn').onclick = () => {
  if (!track) return;
  const capabilities = track.getCapabilities();
  if (!capabilities.torch) {
    alert("‚ö†Ô∏è Flashlight not supported on this device.");
    return;
  }
  torchOn = !torchOn;
  track.applyConstraints({ advanced: [{ torch: torchOn }] });
  document.getElementById('torchBtn').textContent = torchOn ? "üí° Flashlight ON" : "üí° Flashlight OFF";
};

// Block F1‚ÄìF12
window.addEventListener('keydown',e=>{if(/^F\d+$/.test(e.key)){e.preventDefault();e.stopPropagation();return false;}});
</script>
</body>
</html>
