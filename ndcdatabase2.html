<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drug Location Tracker</title>
<style>
  body {
    font-family: system-ui, Arial, sans-serif;
    background: #0e1726;
    color: #e8ecf5;
    margin: 0;
    padding: 20px;
  }
  h1 { text-align: center; color: #4ade80; }
  .controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
  input, select, button {
    padding: 10px; border-radius: 6px; border: none;
    font-size: 16px;
  }
  input { width: 180px; text-align: center; }
  select { background: #1e293b; color: white; }
  button {
    background: #4ade80; color: #0e1726; cursor: pointer;
  }
  button:hover { background: #22c55e; }
  table {
    width: 100%; border-collapse: collapse; margin-top: 20px;
  }
  th, td {
    border: 1px solid #334155; padding: 8px; text-align: center;
  }
  th { background: #1e293b; }
  tr.selected { background: #4ade80; color: #0e1726; }
  #qrArea { display: flex; justify-content: space-around; margin-top: 20px; }
  canvas { background: white; padding: 10px; border-radius: 10px; }
</style>
</head>
<body>
<h1>Drug Location Tracker</h1>

<div class="controls">
  <input type="text" id="ndcInput" placeholder="Scan or enter 11-digit NDC" maxlength="11" autofocus>
  <select id="sectionSelect">
    <option value="">Select Section</option>
    ${Array.from({length:20}, (_,i)=>`<option value="Section ${i+1}">Section ${i+1}</option>`).join('')}
  </select>
  <select id="columnSelect">
    <option value="">Select Column</option>
    ${Array.from({length:20}, (_,i)=>`<option value="Column ${i+1}">Column ${i+1}</option>`).join('')}
  </select>
  <select id="colorSelect">
    <option value="">Select Color</option>
    <option>Red</option>
    <option>Orange</option>
    <option>Yellow</option>
    <option>Green</option>
    <option>Blue</option>
    <option>Purple</option>
    <option>White</option>
    <option>Gray</option>
    <option>Black</option>
    <option>Brown</option>
  </select>
  <button id="setLocation">Set Location</button>
  <button id="backupBtn">Backup</button>
  <input type="file" id="openBackup" accept=".json">
  <button id="clearTable">Clear Table</button>
</div>

<table id="drugTable">
  <thead>
    <tr>
      <th>NDC (11-digit)</th>
      <th>Section</th>
      <th>Column</th>
      <th>Color</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="qrArea">
  <div>
    <h3>Drug QR</h3>
    <canvas id="qrDrug"></canvas>
  </div>
  <div>
    <h3>Location QR</h3>
    <canvas id="qrLocation"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
// Suppress F1–F14
document.addEventListener('keydown', e => {
  if (e.key.startsWith('F') && !isNaN(e.key.substring(1)) && parseInt(e.key.substring(1)) <= 14) {
    e.preventDefault();
  }
});

let currentSection = '';
let currentColumn = '';
let currentColor = '';

document.getElementById('setLocation').addEventListener('click', () => {
  currentSection = document.getElementById('sectionSelect').value;
  currentColumn = document.getElementById('columnSelect').value;
  currentColor = document.getElementById('colorSelect').value;
  if (!currentSection || !currentColumn || !currentColor) {
    alert('Please select Section, Column, and Color first.');
    return;
  }
  localStorage.setItem('lastLocation', JSON.stringify({currentSection, currentColumn, currentColor}));
  alert(`Location set: ${currentSection}, ${currentColumn}, ${currentColor}`);
  document.getElementById('ndcInput').focus();
});

const saved = localStorage.getItem('lastLocation');
if (saved) {
  const { currentSection: s, currentColumn: c, currentColor: col } = JSON.parse(saved);
  currentSection = s; currentColumn = c; currentColor = col;
}

document.getElementById('ndcInput').addEventListener('input', e => {
  const code = e.target.value.trim();
  if (code.length === 11) {
    saveCodeToTable();
  } else if (code.length > 11) {
    alert("⚠️ Code has more than 11 digits. Please rescan.");
    e.target.value = '';
    e.target.focus();
  }
});

function saveCodeToTable() {
  const ndcInput = document.getElementById('ndcInput');
  const code = ndcInput.value.trim();

  if (!currentSection || !currentColumn || !currentColor) {
    alert("Please set location before scanning.");
    ndcInput.value = '';
    ndcInput.focus();
    return;
  }

  if (code.length !== 11) {
    alert("⚠️ Code must be exactly 11 digits. Please rescan.");
    ndcInput.value = '';
    ndcInput.focus();
    return;
  }

  const exists = [...document.querySelectorAll('#drugTable tbody tr')].some(
    row => row.cells[0].innerText === code
  );
  if (exists) {
    alert("Code already exists in the table.");
    ndcInput.value = '';
    ndcInput.focus();
    return;
  }

  const tbody = document.querySelector('#drugTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${code}</td>
    <td>${currentSection}</td>
    <td>${currentColumn}</td>
    <td>${currentColor}</td>
  `;
  tr.addEventListener('click', () => {
    document.querySelectorAll('#drugTable tr').forEach(r => r.classList.remove('selected'));
    tr.classList.add('selected');
    generateQRCode('qrDrug', code);
    generateQRCode('qrLocation', `${currentSection}-${currentColumn}-${currentColor}`);
  });
  tbody.appendChild(tr);

  generateQRCode('qrDrug', code);
  generateQRCode('qrLocation', `${currentSection}-${currentColumn}-${currentColor}`);

  ndcInput.value = '';
  ndcInput.focus();
}

function generateQRCode(canvasId, text) {
  const canvas = document.getElementById(canvasId);
  QRCode.toCanvas(canvas, text, { width: 120 }, err => { if (err) console.error(err); });
}

// Backup to JSON
document.getElementById('backupBtn').addEventListener('click', () => {
  const rows = [...document.querySelectorAll('#drugTable tbody tr')].map(row => ({
    code: row.cells[0].innerText,
    section: row.cells[1].innerText,
    column: row.cells[2].innerText,
    color: row.cells[3].innerText
  }));
  const blob = new Blob([JSON.stringify(rows, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'drug_backup.json';
  a.click();
});

// Open backup
document.getElementById('openBackup').addEventListener('change', function() {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      const tbody = document.querySelector('#drugTable tbody');
      tbody.innerHTML = '';
      data.forEach(item => {
        let tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.code}</td>
          <td>${item.section}</td>
          <td>${item.column}</td>
          <td>${item.color}</td>
        `;
        tr.addEventListener('click', () => {
          document.querySelectorAll('#drugTable tr').forEach(r => r.classList.remove('selected'));
          tr.classList.add('selected');
          generateQRCode('qrDrug', item.code);
          generateQRCode('qrLocation', `${item.section}-${item.column}-${item.color}`);
        });
        tbody.appendChild(tr);
      });
      alert('Backup loaded successfully!');
    } catch(err) {
      alert('Invalid file format.');
    }
  }
  reader.readAsText(file);
});

// Clear table
document.getElementById('clearTable').addEventListener('click', () => {
  if (confirm('Are you sure you want to clear all data?')) {
    document.querySelector('#drugTable tbody').innerHTML = '';
  }
});
</script>
</body>
</html>
