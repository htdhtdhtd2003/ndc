<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drug Location Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f4f4f9;
        color: #333;
    }
    input, select, button {
        padding: 8px;
        margin: 5px;
        font-size: 16px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    th, td {
        border: 1px solid #aaa;
        padding: 8px;
        text-align: center;
    }
    tr.selected {
        background-color: #d3f4ff;
    }
    .qr-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
</style>
</head>
<body>

<h2>Drug Location Tracker</h2>

<div>
    <label>11-digit NDC:</label>
    <input type="text" id="ndcInput" maxlength="11" placeholder="Scan 11-digit NDC">

    <label>12-digit UPC:</label>
    <input type="text" id="upcInput" maxlength="12" placeholder="Scan 12-digit UPC">

    <label>Section:</label>
    <select id="section">
        <option value="">Select Section</option>
    </select>

    <label>Column:</label>
    <select id="column">
        <option value="">Select Column</option>
    </select>

    <label>Color:</label>
    <select id="color">
        <option value="">Select Color</option>
        <option>Red</option>
        <option>Blue</option>
        <option>Green</option>
        <option>Yellow</option>
        <option>Orange</option>
        <option>Purple</option>
        <option>Pink</option>
        <option>White</option>
        <option>Black</option>
        <option>Gray</option>
        <option>Brown</option>
        <option>Silver</option>
        <option>Gold</option>
    </select>

    <button id="setLocation">Set Location</button>
    <button id="saveFile">Save Backup</button>
    <input type="file" id="openFile" style="display:none">
    <button onclick="document.getElementById('openFile').click()">Open Backup</button>
    <button id="clearTable">Clear Table</button>
</div>

<table id="drugTable">
    <thead>
        <tr>
            <th>NDC/UPC</th>
            <th>Section</th>
            <th>Column</th>
            <th>Color</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="qr-container">
    <div>
        <h3>Drug QR Code</h3>
        <canvas id="qrDrug"></canvas>
    </div>
    <div>
        <h3>Location QR Code</h3>
        <canvas id="qrLocation"></canvas>
    </div>
</div>

<script>
// --- Suppress F1 to F14 ---
document.addEventListener('keydown', function(e) {
    if(e.key.startsWith('F') && parseInt(e.key.substring(1)) >= 1 && parseInt(e.key.substring(1)) <= 14) {
        e.preventDefault();
    }
});

let currentLocation = { section: '', column: '', color: '' };

// --- Populate Section & Column 1â€“20 ---
function populateSelectors() {
    const sectionSel = document.getElementById('section');
    const columnSel = document.getElementById('column');
    for (let i = 1; i <= 20; i++) {
        let opt1 = document.createElement('option');
        opt1.value = "Section " + i;
        opt1.textContent = "Section " + i;
        sectionSel.appendChild(opt1);

        let opt2 = document.createElement('option');
        opt2.value = "Column " + i;
        opt2.textContent = "Column " + i;
        columnSel.appendChild(opt2);
    }
}
populateSelectors();

// --- Load last location from localStorage ---
window.onload = function() {
    const savedLocation = JSON.parse(localStorage.getItem('lastLocation'));
    if (savedLocation) {
        currentLocation = savedLocation;
        document.getElementById('section').value = savedLocation.section;
        document.getElementById('column').value = savedLocation.column;
        document.getElementById('color').value = savedLocation.color;
    }
    document.getElementById('ndcInput').focus();
};

// --- Set location ---
document.getElementById('setLocation').addEventListener('click', () => {
    setLocationFromInputs();
});

// --- Automatic scan save for NDC (11 digits) ---
document.getElementById('ndcInput').addEventListener('input', function() {
    if(this.value.length === 11) {
        saveCodeToTable(this.value);
        this.value = '';
        this.focus();
    }
});

// --- Automatic scan save for UPC (12 digits) ---
document.getElementById('upcInput').addEventListener('input', function() {
    if(this.value.length === 12) {
        saveCodeToTable(this.value);
        this.value = '';
        this.focus();
    }
});

// --- Save code to table ---
function saveCodeToTable(code) {
    if (!currentLocation.section || !currentLocation.column || !currentLocation.color) {
        alert('Please set the location first!');
        return;
    }

    // Prevent duplicates
    const exists = [...document.querySelectorAll('#drugTable tbody tr')].some(
        row => row.cells[0].innerText === code
    );
    if (exists) return;

    let tbody = document.getElementById('drugTable').querySelector('tbody');
    let tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${code}</td>
        <td>${currentLocation.section}</td>
        <td>${currentLocation.column}</td>
        <td>${currentLocation.color}</td>
    `;
    tr.addEventListener('click', () => {
        document.querySelectorAll('#drugTable tr').forEach(r => r.classList.remove('selected'));
        tr.classList.add('selected');
        generateQRCode('qrDrug', code);
        generateQRCode('qrLocation', `${currentLocation.section}-${currentLocation.column}-${currentLocation.color}`);
    });
    tbody.appendChild(tr);
    document.getElementById('ndcInput').focus();
}

// --- Generate QR code ---
function generateQRCode(canvasId, text) {
    QRCode.toCanvas(document.getElementById(canvasId), text, { width: 150 }, function (error) {
        if (error) console.error(error);
    });
}

// --- Set location from input fields ---
function setLocationFromInputs() {
    const section = document.getElementById('section').value.trim();
    const column = document.getElementById('column').value.trim();
    const color = document.getElementById('color').value.trim();

    if(!section || !column || !color) {
        alert('Please select Section, Column, and Color.');
        return;
    }

    currentLocation = { section, column, color };
    localStorage.setItem('lastLocation', JSON.stringify(currentLocation));

    alert('Location set! Now scanning will use this location.');
    document.getElementById('ndcInput').focus();
}

// --- Save table to file ---
document.getElementById('saveFile').addEventListener('click', () => {
    const tbody = document.getElementById('drugTable').querySelector('tbody');
    const data = [...tbody.rows].map(row => ({
        code: row.cells[0].innerText,
        section: row.cells[1].innerText,
        column: row.cells[2].innerText,
        color: row.cells[3].innerText
    }));
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'drug_backup.json';
    a.click();
    URL.revokeObjectURL(url);
});

// --- Open backup file ---
document.getElementById('openFile').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            const tbody = document.getElementById('drugTable').querySelector('tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.code}</td>
                    <td>${item.section}</td>
                    <td>${item.column}</td>
                    <td>${item.color}</td>
                `;
                tr.addEventListener('click', () => {
                    document.querySelectorAll('#drugTable tr').forEach(r => r.classList.remove('selected'));
                    tr.classList.add('selected');
                    generateQRCode('qrDrug', item.code);
                    generateQRCode('qrLocation', `${item.section}-${item.column}-${item.color}`);
                });
                tbody.appendChild(tr);
            });
            alert('Backup loaded successfully!');
        } catch(err) {
            alert('Invalid file format');
        }
    }
    reader.readAsText(file);
});

// --- Clear table ---
document.getElementById('clearTable').addEventListener('click', () => {
    if (confirm('Are you sure you want to clear all data?')) {
        document.querySelector('#drugTable tbody').innerHTML = '';
    }
});
</script>

</body>
</html>
