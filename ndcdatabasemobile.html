<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drug Location Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body {
    font-family: system-ui, Arial, sans-serif;
    background: #f5f6fa;
    color: #222;
    margin: 0;
    padding: 10px;
}

h2 {
    text-align: center;
    margin-bottom: 15px;
    color: #333;
}

/* --- MOBILE FRIENDLY FORM LAYOUT --- */
form, .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: space-between;
}

label {
    font-size: 15px;
    font-weight: 600;
}

input, select, button {
    flex: 1 1 100%;
    padding: 12px;
    font-size: 17px;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

input:focus, select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 6px rgba(0, 123, 255, 0.3);
}

button {
    background: #007bff;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
}
button:hover {
    background: #0056b3;
}

/* --- TABLE STYLING --- */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 15px;
}
th, td {
    border: 1px solid #bbb;
    padding: 10px;
    text-align: center;
    word-break: break-word;
}
th {
    background: #007bff;
    color: white;
    position: sticky;
    top: 0;
    z-index: 1;
}
tr:nth-child(even) {
    background-color: #f8f9fa;
}
tr.selected {
    background-color: #d3f4ff !important;
}
.highlight {
    background-color: #ffe3b3 !important;
}

/* --- QR CONTAINERS --- */
.qr-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 25px;
}
.qr-container div {
    text-align: center;
}
canvas {
    margin-top: 10px;
}

/* --- ACTION BAR --- */
.action-bar {
    position: sticky;
    top: 0;
    background: #fff;
    padding: 8px;
    display: flex;
    gap: 8px;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    z-index: 10;
}
.action-bar button {
    flex: 1;
    padding: 10px;
    font-size: 16px;
}

/* --- POPUP MESSAGE --- */
#popup {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 14px 18px;
    background-color: #333;
    color: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    font-size: 17px;
    display: none;
    z-index: 1000;
}

/* --- MOBILE SCROLL --- */
html, body {
    overflow-x: hidden;
    -webkit-tap-highlight-color: transparent;
}
</style>
</head>
<body>

<h2>Drug Location Tracker</h2>

<div class="action-bar">
    <button id="saveFile">ðŸ’¾ Save</button>
    <input type="file" id="openFile" style="display:none">
    <button onclick="document.getElementById('openFile').click()">ðŸ“‚ Open</button>
    <button id="clearTable">ðŸ—‘ Clear</button>
</div>

<form>
    <label>Scan NDC/UPC:</label>
    <input type="text" id="scanInput" maxlength="12" placeholder="Scan or type 11â€“12 digits">

    <label>Search NDC/UPC:</label>
    <input type="text" id="searchInput" maxlength="12" placeholder="Search 11â€“12 digits">

    <label>Section Name:</label>
    <input type="text" id="sectionName" placeholder="Type Fridge, Safe, or Section">

    <label>Number:</label>
    <select id="sectionNumber">
        <option value="">Select Number</option>
    </select>

    <label>Column:</label>
    <select id="column">
        <option value="">Select Column</option>
    </select>

    <label>Color:</label>
    <select id="color">
        <option value="">Select Color</option>
        <option>Red</option><option>Blue</option><option>Green</option><option>Yellow</option>
        <option>Orange</option><option>Purple</option><option>Pink</option><option>White</option>
        <option>Black</option><option>Gray</option><option>Brown</option><option>Silver</option><option>Gold</option>
    </select>
</form>

<table id="drugTable">
    <thead>
        <tr>
            <th>NDC/UPC</th>
            <th>Section</th>
            <th>Column</th>
            <th>Color</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="qr-container">
    <div>
        <h3>Drug QR Code</h3>
        <canvas id="qrDrug"></canvas>
    </div>
    <div>
        <h3>Location QR Code</h3>
        <canvas id="qrLocation"></canvas>
    </div>
</div>

<div id="popup"></div>

<script>
// Prevent F1â€“F14 keys
document.addEventListener('keydown', e => {
    if (e.key.startsWith('F') && +e.key.substring(1) >= 1 && +e.key.substring(1) <= 14) e.preventDefault();
});

let currentLocation = { section: '', column: '', color: '' };
let scanTimer = null;

// Populate selectors
function populateSelectors() {
    const sectionNum = document.getElementById('sectionNumber');
    const columnSel = document.getElementById('column');
    for (let i = 1; i <= 40; i++) {
        sectionNum.innerHTML += `<option value="${i}">${i}</option>`;
        columnSel.innerHTML += `<option value="Column ${i}">Column ${i}</option>`;
    }
}
populateSelectors();

// Load last location
window.onload = function() {
    const saved = JSON.parse(localStorage.getItem('lastLocation'));
    if (saved) {
        currentLocation = saved;
        const [base, number] = (saved.section || '').split(' ');
        document.getElementById('sectionName').value = base || '';
        document.getElementById('sectionNumber').value = number || '';
        document.getElementById('column').value = saved.column || '';
        document.getElementById('color').value = saved.color || '';
    }
    document.getElementById('scanInput').focus();
};

// Update location automatically
['sectionName', 'sectionNumber', 'column', 'color'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateLocation);
    document.getElementById(id).addEventListener('change', updateLocation);
});

function updateLocation() {
    const name = document.getElementById('sectionName').value.trim();
    const number = document.getElementById('sectionNumber').value.trim();
    const column = document.getElementById('column').value.trim();
    const color = document.getElementById('color').value.trim();

    const section = name && number ? `${name} ${number}` : '';
    if (!section && !column && !color) return;

    currentLocation = { section, column, color };
    localStorage.setItem('lastLocation', JSON.stringify(currentLocation));
}

// Handle scanning
document.getElementById('scanInput').addEventListener('input', function() {
    const val = this.value.trim();
    if (val.length >= 11) {
        clearTimeout(scanTimer);
        scanTimer = setTimeout(() => processCode(val), 1000);
    }
});

function processCode(code) {
    const input = document.getElementById('scanInput');
    if (code.length === 11 || code.length === 12) {
        saveToTable(code);
    } else {
        alert('Invalid code. Please rescan.');
    }
    input.value = '';
    input.blur(); // close Android keyboard
    input.focus(); // re-focus for next scan
}

// Save to table
function saveToTable(code) {
    if (!currentLocation.section && !currentLocation.column && !currentLocation.color) {
        alert('Please set a location first!');
        return;
    }
    const tbody = document.querySelector('#drugTable tbody');
    const existing = [...tbody.rows].find(r => r.cells[0].innerText === code);

    if (existing) {
        const old = {
            section: existing.cells[1].innerText,
            column: existing.cells[2].innerText,
            color: existing.cells[3].innerText
        };
        if (confirm(`Code exists at:\n${old.section}, ${old.column}, ${old.color}\n\nChange to:\n${currentLocation.section}, ${currentLocation.column}, ${currentLocation.color}?`)) {
            existing.cells[1].innerText = currentLocation.section;
            existing.cells[2].innerText = currentLocation.column;
            existing.cells[3].innerText = currentLocation.color;
            existing.classList.add('highlight');
            setTimeout(() => existing.classList.remove('highlight'), 1500);
            generateQRCode('qrDrug', code);
            generateQRCode('qrLocation', `${currentLocation.section}-${currentLocation.column}-${currentLocation.color}`);
        }
        return;
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${code}</td><td>${currentLocation.section}</td><td>${currentLocation.column}</td><td>${currentLocation.color}</td>`;
    tr.addEventListener('click', () => selectRow(tr));
    tbody.appendChild(tr);
    generateQRCode('qrDrug', code);
    generateQRCode('qrLocation', `${currentLocation.section}-${currentLocation.column}-${currentLocation.color}`);
    document.getElementById('scanInput').focus();
}

// Select row
function selectRow(tr) {
    document.querySelectorAll('#drugTable tr').forEach(r => r.classList.remove('selected'));
    tr.classList.add('selected');
    const [ndc, sec, col, colr] = [...tr.cells].map(td => td.innerText);
    generateQRCode('qrDrug', ndc);
    generateQRCode('qrLocation', `${sec}-${col}-${colr}`);
}

// QR generator
function generateQRCode(canvasId, text) {
    QRCode.toCanvas(document.getElementById(canvasId), text, { width: 150 }, err => {
        if (err) console.error(err);
    });
}

// Save backup
document.getElementById('saveFile').addEventListener('click', () => {
    const data = [...document.querySelector('#drugTable tbody').rows].map(r => ({
        code: r.cells[0].innerText,
        section: r.cells[1].innerText,
        column: r.cells[2].innerText,
        color: r.cells[3].innerText
    }));
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'drug_backup.json';
    a.click();
});

// Open backup
document.getElementById('openFile').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            const tbody = document.querySelector('#drugTable tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.code}</td><td>${item.section}</td><td>${item.column}</td><td>${item.color}</td>`;
                tr.addEventListener('click', () => selectRow(tr));
                tbody.appendChild(tr);
            });
            alert('Backup loaded successfully!');
            document.getElementById('scanInput').focus();
        } catch {
            alert('Invalid file format.');
        }
    };
    reader.readAsText(file);
});

// Clear table
document.getElementById('clearTable').addEventListener('click', () => {
    if (confirm('Clear all data?')) document.querySelector('#drugTable tbody').innerHTML = '';
});

// --- SEARCH AND SPEAK ---
const popup = document.getElementById('popup');
let searchTimer = null;
document.getElementById('searchInput').addEventListener('input', function() {
    const value = this.value.trim();
    if (value.length === 11 || value.length === 12) {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => searchAndSpeak(value), 1000);
    }
});

function searchAndSpeak(code) {
    const tbody = document.querySelector('#drugTable tbody');
    let foundRow = null;

    for (const row of tbody.rows) {
        if (row.cells[0].innerText.trim() === code) {
            foundRow = row;
            break;
        }
    }

    let message = '';
    if (foundRow) {
        const section = foundRow.cells[1].innerText || '';
        const column = foundRow.cells[2].innerText || '';
        const color = foundRow.cells[3].innerText || '';
        const location = [section, column, color].filter(Boolean).join(", ");
        message = location ? `Location: ${location}` : 'Location not set';
        speakText(message);
    } else {
        message = 'Code not found';
        speakText(message);
    }

    popup.innerText = message;
    popup.style.display = 'block';
    setTimeout(() => popup.style.display = 'none', 5000);

    const input = document.getElementById('searchInput');
    input.value = '';
    input.blur();
    input.focus();
}

function speakText(text) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 0.9;
    utter.pitch = 1.0;
    utter.lang = 'en-US';
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utter);
}
</script>
</body>
</html>
