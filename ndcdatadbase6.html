<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drug Location Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body {
    font-family: system-ui, Arial, sans-serif;
    background: #f4f4f9;
    color: #333;
    margin: 0;
    padding: 20px;
}
input, select, button {
    padding: 8px;
    margin: 5px;
    font-size: 16px;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
th, td {
    border: 1px solid #aaa;
    padding: 8px;
    text-align: center;
}
tr.selected {
    background-color: #d3f4ff;
}
.qr-container {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}
.highlight {
    background-color: #ffe3b3 !important;
}
</style>
</head>
<body>

<h2>Drug Location Tracker</h2>

<div>
    <label>Scan NDC/UPC:</label>
    <input type="text" id="scanInput" maxlength="12" placeholder="Scan 11 or 12-digit barcode" autofocus>

    <label>Section Name:</label>
    <input type="text" id="sectionName" placeholder="Type name (Fridge, Safe, Section)">

    <label>Number:</label>
    <select id="sectionNumber">
        <option value="">Select Number</option>
    </select>

    <label>Column:</label>
    <select id="column">
        <option value="">Select Column</option>
    </select>

    <label>Color:</label>
    <select id="color">
        <option value="">Select Color</option>
        <option>Red</option><option>Blue</option><option>Green</option><option>Yellow</option>
        <option>Orange</option><option>Purple</option><option>Pink</option><option>White</option>
        <option>Black</option><option>Gray</option><option>Brown</option><option>Silver</option><option>Gold</option>
    </select>

    <button id="saveFile">Save Backup</button>
    <input type="file" id="openFile" style="display:none">
    <button onclick="document.getElementById('openFile').click()">Open Backup</button>
    <button id="clearTable">Clear Table</button>
</div>

<table id="drugTable">
    <thead>
        <tr>
            <th>NDC/UPC</th>
            <th>Section</th>
            <th>Column</th>
            <th>Color</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="qr-container">
    <div>
        <h3>Drug QR Code</h3>
        <canvas id="qrDrug"></canvas>
    </div>
    <div>
        <h3>Location QR Code</h3>
        <canvas id="qrLocation"></canvas>
    </div>
</div>

<script>
// Suppress F1–F14
document.addEventListener('keydown', e => {
    if (e.key.startsWith('F') && +e.key.substring(1) >= 1 && +e.key.substring(1) <= 14) e.preventDefault();
});

let currentLocation = { section: '', column: '', color: '' };
let scanTimer = null;

// Populate selectors 1–20
function populateSelectors() {
    const sectionNum = document.getElementById('sectionNumber');
    const columnSel = document.getElementById('column');
    for (let i = 1; i <= 20; i++) {
        sectionNum.innerHTML += `<option value="${i}">${i}</option>`;
        columnSel.innerHTML += `<option value="Column ${i}">Column ${i}</option>`;
    }
}
populateSelectors();

// Load last location
window.onload = function() {
    const saved = JSON.parse(localStorage.getItem('lastLocation'));
    if (saved) {
        currentLocation = saved;
        const [base, number] = (saved.section || '').split(' ');
        document.getElementById('sectionName').value = base || '';
        document.getElementById('sectionNumber').value = number || '';
        document.getElementById('column').value = saved.column || '';
        document.getElementById('color').value = saved.color || '';
    }
    document.getElementById('scanInput').focus();
};

// Update location automatically
['sectionName', 'sectionNumber', 'column', 'color'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateLocation);
    document.getElementById(id).addEventListener('change', updateLocation);
});

function updateLocation() {
    const name = document.getElementById('sectionName').value.trim();
    const number = document.getElementById('sectionNumber').value.trim();
    const column = document.getElementById('column').value.trim();
    const color = document.getElementById('color').value.trim();

    const section = name && number ? `${name} ${number}` : '';
    if (!section && !column && !color) return;

    currentLocation = { section, column, color };
    localStorage.setItem('lastLocation', JSON.stringify(currentLocation));
    console.log('Location set:', currentLocation);
}

// Handle scanning
document.getElementById('scanInput').addEventListener('input', function() {
    const val = this.value.trim();
    if (val.length >= 11) {
        clearTimeout(scanTimer);
        scanTimer = setTimeout(() => processCode(val), 1000);
    }
});

function processCode(code) {
    const input = document.getElementById('scanInput');
    if (code.length === 11 || code.length === 12) {
        saveToTable(code);
    } else {
        alert('Invalid code. Please rescan.');
    }
    input.value = '';
    input.focus();
}

// Save to table
function saveToTable(code) {
    if (!currentLocation.section && !currentLocation.column && !currentLocation.color) {
    alert('Please set at least one location option (Section, Column, or Color) first!');
    return;
}


    const tbody = document.querySelector('#drugTable tbody');
    const existing = [...tbody.rows].find(r => r.cells[0].innerText === code);

    if (existing) {
        const old = {
            section: existing.cells[1].innerText,
            column: existing.cells[2].innerText,
            color: existing.cells[3].innerText
        };
        if (confirm(`Code exists at:\n${old.section}, ${old.column}, ${old.color}\n\nChange to:\n${currentLocation.section}, ${currentLocation.column}, ${currentLocation.color}?`)) {
            existing.cells[1].innerText = currentLocation.section;
            existing.cells[2].innerText = currentLocation.column;
            existing.cells[3].innerText = currentLocation.color;
            existing.classList.add('highlight');
            setTimeout(() => existing.classList.remove('highlight'), 1500);
            generateQRCode('qrDrug', code);
            generateQRCode('qrLocation', `${currentLocation.section}-${currentLocation.column}-${currentLocation.color}`);
        }
        return;
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${code}</td><td>${currentLocation.section}</td><td>${currentLocation.column}</td><td>${currentLocation.color}</td>`;
    tr.addEventListener('click', () => selectRow(tr));
    tbody.appendChild(tr);
    document.getElementById('scanInput').focus();
}

// Row click → show QR
function selectRow(tr) {
    document.querySelectorAll('#drugTable tr').forEach(r => r.classList.remove('selected'));
    tr.classList.add('selected');
    const [ndc, sec, col, colr] = [...tr.cells].map(td => td.innerText);
    generateQRCode('qrDrug', ndc);
    generateQRCode('qrLocation', `${sec}-${col}-${colr}`);
}

// QR generator
function generateQRCode(canvasId, text) {
    QRCode.toCanvas(document.getElementById(canvasId), text, { width: 150 }, err => {
        if (err) console.error(err);
    });
}

// Save backup
document.getElementById('saveFile').addEventListener('click', () => {
    const data = [...document.querySelector('#drugTable tbody').rows].map(r => ({
        code: r.cells[0].innerText,
        section: r.cells[1].innerText,
        column: r.cells[2].innerText,
        color: r.cells[3].innerText
    }));
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'drug_backup.json';
    a.click();
});

// Open backup
document.getElementById('openFile').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            const tbody = document.querySelector('#drugTable tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.code}</td><td>${item.section}</td><td>${item.column}</td><td>${item.color}</td>`;
                tr.addEventListener('click', () => selectRow(tr));
                tbody.appendChild(tr);
            });
            alert('Backup loaded successfully!');
            document.getElementById('scanInput').focus();
        } catch {
            alert('Invalid file format.');
        }
    };
    reader.readAsText(file);
});

// Clear table
document.getElementById('clearTable').addEventListener('click', () => {
    if (confirm('Clear all data?')) document.querySelector('#drugTable tbody').innerHTML = '';
});
</script>

</body>
</html>
