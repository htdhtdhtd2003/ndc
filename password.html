<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Encrypt credentials to file (AES-GCM)</title>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; max-width: 720px; }
    label { display:block; margin-top:12px; }
    input[type="text"], input[type="password"], textarea { width:100%; padding:8px; box-sizing:border-box; }
    button { margin-top:10px; padding:8px 12px; }
    pre { background:#f6f6f6; padding:12px; border-radius:6px; overflow:auto; }
    .hint { color: #666; font-size:0.9em; margin-top:6px; }
  </style>
</head>
<body>
  <h1>Encrypt credentials to a file (AES-GCM)</h1>

  <section>
    <label>Username
      <input id="username" type="text" placeholder="example: alice@example.com">
    </label>

    <label>Password
      <input id="password" type="password" placeholder="your secret password">
    </label>

    <label>Encryption passphrase (required to decrypt)
      <input id="passphrase" type="password" placeholder="Choose a strong passphrase">
    </label>
    <div class="hint">Passphrase is used to derive the AES key (PBKDF2). If you lose it, the file cannot be decrypted.</div>

    <button id="encryptDownloadBtn">Encrypt & Download file</button>
  </section>

  <hr>

  <section>
    <label>Load encrypted file
      <input id="fileInput" type="file" accept="application/json">
    </label>

    <label>Passphrase to decrypt
      <input id="decryptPassphrase" type="password" placeholder="Enter the passphrase used to encrypt">
    </label>

    <button id="decryptBtn">Decrypt file</button>

    <div id="result" style="margin-top:12px;"></div>
  </section>

  <hr>

  <h3>How the file looks (JSON)</h3>
  <pre id="sample" aria-hidden="true"></pre>

<script>
/* ---------- Helpers ---------- */
function arrayBufferToBase64(buffer) {
  const bytes = new Uint8Array(buffer);
  let binary = '';
  const chunk = 0x8000;
  for (let i = 0; i < bytes.length; i += chunk) {
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
  }
  return btoa(binary);
}
function base64ToArrayBuffer(base64) {
  const binary = atob(base64);
  const len = binary.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
  return bytes.buffer;
}

/* Derive AES-GCM key from passphrase using PBKDF2 */
async function deriveKeyFromPassphrase(passphrase, salt, iterations = 150_000) {
  const enc = new TextEncoder();
  const passKey = await crypto.subtle.importKey(
    'raw', enc.encode(passphrase), {name: 'PBKDF2'}, false, ['deriveKey']
  );
  const key = await crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: salt, iterations, hash: 'SHA-256' },
    passKey,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt','decrypt']
  );
  return key;
}

/* Encrypt a JS object (JSON) */
async function encryptObject(obj, passphrase) {
  const enc = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv   = crypto.getRandomValues(new Uint8Array(12));
  const key  = await deriveKeyFromPassphrase(passphrase, salt);

  const plaintext = enc.encode(JSON.stringify(obj));
  const cipherBuffer = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, plaintext);

  return {
    version: 1,
    iterations: 150000,
    salt: arrayBufferToBase64(salt.buffer),
    iv: arrayBufferToBase64(iv.buffer),
    ciphertext: arrayBufferToBase64(cipherBuffer)
  };
}

/* Decrypt */
async function decryptPayload(payloadJson, passphrase) {
  const salt = base64ToArrayBuffer(payloadJson.salt);
  const iv   = base64ToArrayBuffer(payloadJson.iv);
  const ct   = base64ToArrayBuffer(payloadJson.ciphertext);
  const iters = payloadJson.iterations || 150000;

  const key = await deriveKeyFromPassphrase(passphrase, new Uint8Array(salt), iters);
  const decryptedBuffer = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: new Uint8Array(iv) }, key, ct);
  return JSON.parse(new TextDecoder().decode(decryptedBuffer));
}

/* Download JSON reliably */
function downloadObjectAsJson(obj, filename) {
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ---------- UI ---------- */
document.getElementById('encryptDownloadBtn').addEventListener('click', async () => {
  const username   = document.getElementById('username').value || '';
  const password   = document.getElementById('password').value || '';
  const passphrase = document.getElementById('passphrase').value || '';

  if (!passphrase) { alert('Enter an encryption passphrase.'); return; }

  const payload = { username, password, createdAt: new Date().toISOString() };
  try {
    const encrypted = await encryptObject(payload, passphrase);
    downloadObjectAsJson(encrypted, 'credentials-encrypted.json');
  } catch (err) {
    console.error(err);
    alert('Encryption failed: ' + err.message);
  }
});

let loadedEncrypted = null;
document.getElementById('fileInput').addEventListener('change', async (evt) => {
  const f = evt.target.files[0];
  if (!f) return;
  const txt = await f.text();
  try {
    loadedEncrypted = JSON.parse(txt);
    document.getElementById('sample').textContent = JSON.stringify(loadedEncrypted, null, 2);
    document.getElementById('result').textContent = 'Encrypted file loaded. Enter passphrase and click Decrypt.';
  } catch {
    loadedEncrypted = null;
    document.getElementById('result').textContent = 'Invalid file format.';
  }
});

document.getElementById('decryptBtn').addEventListener('click', async () => {
  if (!loadedEncrypted) { alert('Load a file first.'); return; }
  const passphrase = document.getElementById('decryptPassphrase').value || '';
  if (!passphrase) { alert('Enter passphrase.'); return; }
  try {
    const obj = await decryptPayload(loadedEncrypted, passphrase);
    document.getElementById('result').innerHTML =
      '<strong>Decrypted payload:</strong><pre>' + JSON.stringify(obj, null, 2) + '</pre>';
  } catch (err) {
    console.error(err);
    document.getElementById('result').textContent = 'Decryption failed: ' + err.message;
  }
});

/* Show an example structure */
document.getElementById('sample').textContent = JSON.stringify({
  version: 1,
  iterations: 150000,
  salt: "<base64>",
  iv: "<base64>",
  ciphertext: "<base64>"
}, null, 2);
</script>
</body>
</html>
