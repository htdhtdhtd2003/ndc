<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Encrypted Credential Vault</title>
  <style>
    body { font-family: system-ui, Arial; margin: 20px; }
    label { display:block; margin-top:10px; }
    input, textarea { width:100%; padding:6px; margin-top:4px; box-sizing:border-box; font-size:14px; }
    button { margin-top:8px; padding:6px 12px; }
    table { width:100%; border-collapse: collapse; margin-top:20px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:left; }
    th { background:#f6f6f6; }
    td button { margin-right:4px; }
    .status { margin-top:10px; font-size:0.9em; color:#444; }
    .controls { margin-top:10px; }
  </style>
</head>
<body>
<h1>Encrypted Credential Vault</h1>

<section>
  <h2>Add Credential</h2>
  <label>Name <input id="name"></label>
  <label>URL (optional) <input id="url" autocapitalize="off"></label>
  <label>Username <input id="username"></label>
  <label>Password <input id="password" type="password"></label>
  <label>Notes (optional) <textarea id="notes"></textarea></label>

  <!-- Vault passphrase for saving / re-keying -->
  <label>Vault Passphrase (required for Save)
    <input id="savePassphrase" type="password">
  </label>

  <button id="addBtn">Add Entry</button>
  <button id="saveBtn">Save Vault</button>
  <button id="exportBtn">Export As New File</button>

  <div class="controls">
    <label><input type="checkbox" id="showPasswords"> Show passwords</label>
  </div>
  <div class="status" id="status"></div>
</section>

<hr>

<section>
  <h2>Load Vault</h2>
  <input id="fileInput" type="file" accept="application/json">
  <label>Passphrase to decrypt <input id="decryptPassphrase" type="password"></label>
  <button id="decryptBtn">Open Vault</button>
</section>

<h2>Stored Credentials</h2>
<table id="credTable">
  <thead>
    <tr>
      <th>Name</th>
      <th>URL</th>
      <th>Username</th>
      <th>Password</th>
      <th>Notes</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
/* ====== Crypto helpers ====== */
function arrayBufferToBase64(buf){return btoa(String.fromCharCode(...new Uint8Array(buf)));}
function base64ToArrayBuffer(b64){return Uint8Array.from(atob(b64),c=>c.charCodeAt(0)).buffer;}

async function deriveKey(passphrase,salt,iters=150000){
  const enc=new TextEncoder();
  const keyMaterial=await crypto.subtle.importKey("raw",enc.encode(passphrase),{name:"PBKDF2"},false,["deriveKey"]);
  return crypto.subtle.deriveKey(
    {name:"PBKDF2",salt,iterations:iters,hash:"SHA-256"},
    keyMaterial,
    {name:"AES-GCM",length:256},
    false,["encrypt","decrypt"]);
}

async function encryptData(obj,passphrase){
  const enc=new TextEncoder();
  const salt=crypto.getRandomValues(new Uint8Array(16));
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const key=await deriveKey(passphrase,salt);
  const plaintext=enc.encode(JSON.stringify(obj));
  const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,plaintext);
  return {
    version:1,iterations:150000,
    salt:arrayBufferToBase64(salt.buffer),
    iv:arrayBufferToBase64(iv.buffer),
    ciphertext:arrayBufferToBase64(ct)
  };
}

async function decryptData(payload,passphrase){
  const salt=base64ToArrayBuffer(payload.salt);
  const iv=base64ToArrayBuffer(payload.iv);
  const ct=base64ToArrayBuffer(payload.ciphertext);
  const key=await deriveKey(passphrase,new Uint8Array(salt),payload.iterations||150000);
  const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(iv)},key,ct);
  return JSON.parse(new TextDecoder().decode(pt));
}

/* ====== State ====== */
let credentials=[]; 
let loadedEncrypted=null;
let currentPassphrase=null;
let currentFilename="credentials-vault.json";
let showPasswords=false;

/* ====== UI rendering ====== */
function renderTable(){
  const tbody=document.querySelector("#credTable tbody");
  tbody.innerHTML="";
  credentials.forEach((c,idx)=>{
    const tr=document.createElement("tr");
    const pwDisplay = showPasswords ? (c.password||"") : "••••••";
    tr.innerHTML=`
      <td>${c.name||""}</td>
      <td>${c.url||""}</td>
      <td>${c.username||""}</td>
      <td>${pwDisplay}</td>
      <td>${c.notes||""}</td>
      <td>
        <button onclick="editEntry(${idx})">Edit</button>
        <button onclick="deleteEntry(${idx})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

window.editEntry=function(idx){
  const c=credentials[idx];
  document.getElementById("name").value=c.name;
  document.getElementById("url").value=c.url;
  document.getElementById("username").value=c.username;
  document.getElementById("password").value=c.password;
  document.getElementById("notes").value=c.notes;
  credentials.splice(idx,1); 
  renderTable();
};

window.deleteEntry=function(idx){
  const c=credentials[idx];
  if(confirm(`Are you sure you want to delete:\n\n${c.name} (${c.username})?`)){
    credentials.splice(idx,1);
    renderTable();
  }
};

/* ====== Download ====== */
function downloadJson(obj,filename){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download=filename;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ====== Event handlers ====== */
document.getElementById("addBtn").addEventListener("click",()=>{
  const entry={
    name:document.getElementById("name").value,
    url:document.getElementById("url").value,
    username:document.getElementById("username").value,
    password:document.getElementById("password").value,
    notes:document.getElementById("notes").value
  };
  credentials.push(entry);
  renderTable();
  ["name","url","username","password","notes"].forEach(id=>document.getElementById(id).value="");
});

async function doSave(filename){
  let pass = document.getElementById("savePassphrase").value.trim();
  if(pass){
    currentPassphrase = pass; // new or re-key
  }
  if(!currentPassphrase){
    alert("Enter a vault passphrase before saving");
    return;
  }
  try{
    const encrypted = await encryptData({entries:credentials}, currentPassphrase);
    downloadJson(encrypted, filename);
    document.getElementById("status").textContent = "Vault saved as " + filename;

    // Clear passphrase
    document.getElementById("savePassphrase").value = "";

    // ✅ Clear table after save/export
    credentials = [];
    renderTable();
  } catch(e){
    alert("Encryption failed: " + e.message);
  }
}

document.getElementById("saveBtn").addEventListener("click",()=>doSave(currentFilename));
document.getElementById("exportBtn").addEventListener("click",()=>doSave("credentials-"+Date.now()+".json"));

document.getElementById("decryptBtn").addEventListener("click",async()=>{
  if(!loadedEncrypted){alert("Load an encrypted file first");return;}
  const pass=document.getElementById("decryptPassphrase").value;
  if(!pass){alert("Enter passphrase");return;}
  try{
    const data=await decryptData(loadedEncrypted,pass);
    credentials=data.entries||[];
    currentPassphrase=pass;
    renderTable();
    document.getElementById("status").textContent="Vault opened: "+currentFilename;
    document.getElementById("decryptPassphrase").value=""; // clear after open
  }catch(e){alert("Decryption failed: "+e.message);}
});

document.getElementById("fileInput").addEventListener("change",async e=>{
  const f=e.target.files[0];
  if(!f)return;
  const txt=await f.text();
  try{
    loadedEncrypted=JSON.parse(txt);
    currentFilename=f.name;
    document.getElementById("status").textContent="Loaded file "+f.name+" (enter passphrase to open)";
  }catch{alert("Invalid file");}
});

/* ====== Show/Hide Passwords ====== */
document.getElementById("showPasswords").addEventListener("change",e=>{
  showPasswords=e.target.checked;
  const type = showPasswords ? "text" : "password";
  document.getElementById("password").type=type;
  document.getElementById("savePassphrase").type=type;
  document.getElementById("decryptPassphrase").type=type;
  renderTable();
});
</script>
</body>
</html>
