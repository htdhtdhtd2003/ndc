<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Scheduler + Print Friendly</title>

<style>
  body { font-family: Arial, sans-serif; padding: 10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: auto; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #f4f4f4; }
  input { width: 98%; padding: 4px; font-size: 14px; }
  button { padding: 6px 10px; margin: 4px 2px; }
  .total-row { background: #eef7ff; font-weight: bold; }
  .week-block { border: 2px solid #0077ff; padding: 10px; margin-bottom: 20px; border-radius: 8px; }
  .week-title { font-size: 19px; font-weight: bold; margin-bottom: 6px; }
  #topButtons button { margin-right: 6px; }
  .removeBtn { background-color: #ff4d4d; color: white; border: none; cursor: pointer; padding: 4px 6px; }
  .removeBtn:hover { background-color: #ff1a1a; }

  /* Print-friendly layout */
  @media print {
    @page {
      size: letter landscape;
      margin: 0.3in;
    }
    body { padding: 0; margin: 0; font-size: 12px; }
    button { display: none; }
    input { border: none; width: 100%; font-size: 12px; padding: 0; }
    table { width: 100%; table-layout: fixed; font-size: 12px; border-collapse: collapse; }
    th, td { padding: 2px; word-wrap: break-word; border: 1px solid #000; }
    .week-block { page-break-after: always; border: none; padding: 0; margin: 0; }
    .week-title { font-size: 14px; }
    /* Hide Remove column in print */
    th:last-child, td:last-child { display: none; }
  }
</style>
</head>

<body>

<h2>Weekly Scheduler</h2>

<div id="topButtons">
  <button onclick="createNewWeek()">‚ûï Add New Week</button>
  <button onclick="exportData()">‚¨á Export</button>
  <button onclick="triggerImport()">‚¨Ü Import</button>
  <button onclick="saveLocal()">üíæ Save</button>
  <button onclick="loadLocal()">üìÇ Load</button>
  <button onclick="window.print()">üñ® Print</button>
</div>

<input type="file" id="importFile" style="display:none" accept=".json" onchange="handleImport(event)">

<div id="weeksContainer"></div>

<script>
let weekCount = 0;

// -------------------------
// CREATE NEW WEEK
// -------------------------
function createNewWeek(copyEmployees = false) {
  weekCount++;

  let container = document.getElementById("weeksContainer");
  let autoDate = "";
  if (weekCount > 1) {
    let prevStart = document.querySelector(`#week_${weekCount-1} .weekStartInput`).value;
    if (prevStart) {
      let [y, m, d] = prevStart.split("-").map(Number);
      let dt = new Date(y, m-1, d);
      dt.setDate(dt.getDate() + 7);
      autoDate = dt.toISOString().split("T")[0];
    }
  }

  let block = document.createElement("div");
  block.className = "week-block";
  block.id = "week_" + weekCount;

  block.innerHTML = `
    <div class="week-title">Week ${weekCount}</div>
    <label><b>Week Beginning (Sunday):</b></label><br>
    <input type="date" class="weekStartInput" value="${autoDate}">
    <p class="dateError" style="color:red;font-size:14px;"></p>

    <br>
    <button onclick="addEmployee(${weekCount})">+ Add Employee</button>
    <button onclick="copyPreviousWeekEmployees(${weekCount})">‚§µ Copy Previous Week Employees</button>

    <table>
      <thead>
        <tr class="headerRow">
          <th>Employee</th>
          <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
          <th>Total Hours</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody class="tbody"></tbody>
      <tfoot>
        <tr class="total-row">
          <td colspan="9">Total Hours (All Employees)</td>
          <td class="grandTotal">0.00</td>
        </tr>
      </tfoot>
    </table>
  `;

  container.appendChild(block);

  let input = block.querySelector(".weekStartInput");
  input.addEventListener("change", () => validateAndUpdateHeaders(block.id));

  if (autoDate) validateAndUpdateHeaders(block.id);
  if (copyEmployees) copyPreviousWeekEmployees(weekCount);
}

// -------------------------
// DATE FORMAT
// -------------------------
function fmt(date){ return (date.getMonth()+1).toString().padStart(2,"0") + "/" + date.getDate().toString().padStart(2,"0"); }

// -------------------------
// VALIDATE DATE + HEADERS
// -------------------------
function validateAndUpdateHeaders(weekId){
  let block=document.getElementById(weekId);
  let input=block.querySelector(".weekStartInput");
  let error=block.querySelector(".dateError");
  if(!input.value) return;

  let [y,m,d]=input.value.split("-").map(Number);
  let date=new Date(y,m-1,d);

  if(date.getDay()!==0){ error.textContent="‚ùå Date must be a Sunday."; input.value=""; return; }
  error.textContent="";

  let header=block.querySelector(".headerRow").children;
  for(let i=1;i<=7;i++){
    let dt=new Date(date);
    dt.setDate(date.getDate()+(i-1));
    header[i].textContent=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][i-1] + " (" + fmt(dt) + ")";
  }
}

// -------------------------
// TIME PARSING
// -------------------------
function parseTime(str){ if(!str) return null; str=str.toLowerCase().replace(/\s+/g,""); let m=str.match(/^(\d{1,2})(:?(\d{2}))?(a|p)$/); if(!m) return null; let h=parseInt(m[1]), mins=m[3]?parseInt(m[3]):0, ap=m[4]; if(ap==='p'&&h!==12)h+=12; if(ap==='a'&&h===12)h=0; return h*60+mins;}
function calcHours(range){ if(!range||!range.includes("-")) return 0; let [s,e]=range.split("-"); let start=parseTime(s), end=parseTime(e); if(start===null||end===null) return 0; let diff=end-start; if(diff<0) diff+=1440; return diff/60;}
function recalcTotals(block){ let grand=0; block.querySelectorAll(".empRow").forEach(row=>{ let total=0; row.querySelectorAll(".timeInput").forEach(inp=>total+=calcHours(inp.value)); row.querySelector(".empTotal").textContent=total.toFixed(2); grand+=total; }); block.querySelector(".grandTotal").textContent=grand.toFixed(2);}

// -------------------------
// ADD / REMOVE EMPLOYEE
// -------------------------
function addEmployee(weekNum){
  let block=document.getElementById("week_"+weekNum);
  let tbody=block.querySelector(".tbody");
  let row=document.createElement("tr");
  row.className="empRow";
  row.innerHTML=`
    <td><input class="empName" placeholder=""></td>
    ${"<td><input class='timeInput' placeholder=''></td>".repeat(7)}
    <td class="empTotal">0.00</td>
    <td><button class="removeBtn" onclick="removeEmployee(this)">Remove</button></td>
  `;
  tbody.appendChild(row);
  row.querySelectorAll("input").forEach(inp=>inp.addEventListener("input",()=>recalcTotals(block)));
}
function removeEmployee(btn){ let row=btn.closest("tr"); let block=row.closest(".week-block"); row.remove(); recalcTotals(block); }

// -------------------------
// COPY PREVIOUS WEEK EMPLOYEES
// -------------------------
function copyPreviousWeekEmployees(currentWeek){
  if(currentWeek<=1) return;
  let prev=document.getElementById("week_"+(currentWeek-1));
  let curr=document.getElementById("week_"+currentWeek);
  let names=[...prev.querySelectorAll(".empName")].map(i=>i.value);
  names.forEach(name=>{
    let tbody=curr.querySelector(".tbody");
    let row=document.createElement("tr"); row.className="empRow";
    row.innerHTML=`
      <td><input class="empName" value="${name}"></td>
      ${"<td><input class='timeInput' placeholder='915a-8p'></td>".repeat(7)}
      <td class="empTotal">0.00</td>
      <td><button class="removeBtn" onclick="removeEmployee(this)">Remove</button></td>
    `;
    tbody.appendChild(row);
    row.querySelectorAll("input").forEach(inp=>inp.addEventListener("input",()=>recalcTotals(curr)));
  });
}

// -------------------------
// EXPORT / IMPORT / LOCAL STORAGE
// -------------------------
function exportData(){
  let data={weeks:[]};
  for(let i=1;i<=weekCount;i++){
    let block=document.getElementById("week_"+i); if(!block) continue;
    let start=block.querySelector(".weekStartInput").value;
    let employees=[]; block.querySelectorAll(".empRow").forEach(row=>{ let name=row.querySelector(".empName").value; let times=[...row.querySelectorAll(".timeInput")].map(i=>i.value); employees.push({name,times}); });
    data.weeks.push({start,employees});
  }
  let blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a"); a.href=url; a.download="schedule.json"; a.click();
}

function triggerImport(){ document.getElementById("importFile").click(); }
function handleImport(e){ let file=e.target.files[0]; if(!file) return; let reader=new FileReader(); reader.onload=function(evt){ importObject(JSON.parse(evt.target.result)); }; reader.readAsText(file); }

function saveLocal(){ let data={weeks:[]}; for(let i=1;i<=weekCount;i++){ let block=document.getElementById("week_"+i); if(!block) continue; let start=block.querySelector(".weekStartInput").value; let employees=[]; block.querySelectorAll(".empRow").forEach(row=>{ let name=row.querySelector(".empName").value; let times=[...row.querySelectorAll(".timeInput")].map(i=>i.value); employees.push({name,times}); }); data.weeks.push({start,employees}); } localStorage.setItem("schedulerData",JSON.stringify(data)); alert("Saved locally!"); }

function loadLocal(){ let raw=localStorage.getItem("schedulerData"); if(!raw) return alert("No saved data found."); importObject(JSON.parse(raw)); }

function importObject(obj){ document.getElementById("weeksContainer").innerHTML=""; weekCount=0; obj.weeks.forEach(week=>{ createNewWeek(false); let block=document.getElementById("week_"+weekCount); block.querySelector(".weekStartInput").value=week.start; validateAndUpdateHeaders(block.id); let tbody=block.querySelector(".tbody"); week.employees.forEach(emp=>{ let row=document.createElement("tr"); row.className="empRow"; row.innerHTML=`<td><input class="empName" value="${emp.name}"></td>${emp.times.map(t=>`<td><input class='timeInput' value="${t}"></td>`).join("")}<td class="empTotal">0.00</td><td><button class="removeBtn" onclick="removeEmployee(this)">Remove</button></td>`; tbody.appendChild(row); row.querySelectorAll("input").forEach(inp=>inp.addEventListener("input",()=>recalcTotals(block))); }); recalcTotals(block); }); }
</script>

</body>
</html>
