<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Scheduler + PTO + GitHub + JSON + Local</title>

<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
  .controls { margin-bottom: 20px; }
  .week-container { 
    background: white; 
    padding: 15px; 
    border: 1px solid #ccc; 
    border-radius: 10px; 
    margin-bottom: 25px;
  }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #888; padding: 6px; text-align: center; }
  button { padding: 8px 12px; margin: 5px; cursor: pointer; }
  .delete-week { background: #d9534f; color: white; border: none; border-radius: 6px; }
  .add-week { background: #0275d8; color: white; border: none; border-radius: 6px; }
  .save-btn { background: #5cb85c; color: white; border: none; border-radius: 6px; }
  .load-btn { background: #5bc0de; color: white; border: none; border-radius: 6px; }
  .totalCell { background: #eef8ff; font-weight: bold; }
</style>

</head>
<body>

<h1>Weekly Scheduler</h1>

<div class="controls">
  <button class="add-week" onclick="createWeek()">+ Add Week</button>
  <br><br>

  <label><b>GitHub Token (ONLY for save):</b></label><br>
  <input id="githubToken" type="password" placeholder="GitHub Personal Access Token">
  <br><br>

  <button class="save-btn" onclick="exportToGitHub()">Save to GitHub</button>
  <button class="load-btn" onclick="importFromGitHub()">Load from GitHub</button>

  <br><br>
  <button onclick="exportLocalFile()">Export JSON File</button>
  <input type="file" id="fileInput" onchange="importLocalFile()">
</div>


<div id="weeks"></div>


<script>
// GitHub Repo Configuration
const githubUser = "htdhtdhtd2003";
const githubRepo = "ndc";
const githubPath = "schedule560.json";


// ---------------------- PTO & Time Calculation ----------------------
function parseHours(text) {
    text = text.trim();

    if (text.toLowerCase() === "pto") return 8;

    if (!text.includes("-")) return 0;

    let [start, end] = text.split("-");

    function convert(t) {
        t = t.trim().toLowerCase();
        let [num, ampm] = t.split(/(am|pm)/);
        let [h, m] = num.split(":").map(Number);
        if (ampm === "pm" && h !== 12) h += 12;
        if (ampm === "am" && h === 12) h = 0;
        return h + (m || 0) / 60;
    }

    return Math.max(0, convert(end) - convert(start));
}

function updateTotals(weekDiv) {
    const rows = weekDiv.querySelectorAll("tbody tr");

    rows.forEach(row => {
        const cells = [...row.children];
        let total = 0;

        for (let i = 1; i <= 7; i++) {
            total += parseHours(cells[i].innerText);
        }

        cells[8].innerText = total.toFixed(2);
    });
}



// ---------------------- CREATE WEEK ----------------------
function createWeek(loadedData = null) {
    const container = document.getElementById("weeks");

    const weekDiv = document.createElement("div");
    weekDiv.className = "week-container";

    const delBtn = document.createElement("button");
    delBtn.textContent = "Delete This Week";
    delBtn.className = "delete-week";
    delBtn.onclick = () => {
        if (confirm("Delete this week?")) {
            weekDiv.remove();
            saveLocal();
        }
    };

    weekDiv.appendChild(delBtn);

    const table = document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>Employee</th>
          <th>Sun</th><th>Mon</th><th>Tue</th>
          <th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;

    const tbody = table.querySelector("tbody");

    const rows = loadedData ? loadedData : [
        ["", "", "", "", "", "", "", "", "0"],
        ["", "", "", "", "", "", "", "", "0"],
        ["", "", "", "", "", "", "", "", "0"]
    ];

    rows.forEach(row => {
        const tr = document.createElement("tr");

        row.forEach((cell, i) => {
            const td = document.createElement("td");
            td.innerText = cell;

            td.contentEditable = i !== 8;
            if (i === 8) td.classList.add("totalCell");

            td.oninput = () => {
                updateTotals(weekDiv);
                saveLocal();
            };

            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });

    weekDiv.appendChild(table);
    container.appendChild(weekDiv);

    updateTotals(weekDiv);
    saveLocal();
}



// ---------------------- LOCAL STORAGE SAVE/LOAD ----------------------
function saveLocal() {
    const weeks = [...document.querySelectorAll(".week-container")].map(week =>
        [...week.querySelectorAll("tbody tr")].map(tr =>
            [...tr.children].map(td => td.innerText)
        )
    );

    localStorage.setItem("schedule560_data", JSON.stringify(weeks));
}

function loadLocal() {
    const data = localStorage.getItem("schedule560_data");
    if (!data) return;
    const weeks = JSON.parse(data);
    weeks.forEach(w => createWeek(w));
}



// ---------------------- EXPORT JSON FILE ----------------------
function exportLocalFile() {
    const data = localStorage.getItem("schedule560_data") || "[]";

    const blob = new Blob([data], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "schedule560.json";
    a.click();
}



// ---------------------- IMPORT JSON FILE ----------------------
function importLocalFile() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        const weeks = JSON.parse(e.target.result);
        document.getElementById("weeks").innerHTML = "";
        weeks.forEach(w => createWeek(w));
        saveLocal();
    };
    reader.readAsText(file);
}



// ---------------------- GITHUB IMPORT (FIXED) ----------------------
async function importFromGitHub() {
    const timestamp = Date.now();
    const url = `https://raw.githubusercontent.com/${githubUser}/${githubRepo}/main/${githubPath}?v=${timestamp}`;

    try {
        const res = await fetch(url, { cache: "no-store" });

        if (!res.ok) {
            alert("Failed to load file from GitHub.");
            return;
        }

        const weeks = await res.json();

        document.getElementById("weeks").innerHTML = "";
        weeks.forEach(w => createWeek(w));

        saveLocal();
        alert("Loaded successfully from GitHub!");

    } catch (err) {
        alert("GitHub import failed.");
    }
}



// ---------------------- GITHUB EXPORT ----------------------
async function exportToGitHub() {
    const token = document.getElementById("githubToken").value.trim();
    if (!token) return alert("GitHub token required.");

    const weeks = [...document.querySelectorAll(".week-container")].map(week =>
        [...week.querySelectorAll("tbody tr")].map(tr =>
            [...tr.children].map(td => td.innerText)
        )
    );

    const content = JSON.stringify(weeks, null, 2);
    const getUrl = `https://api.github.com/repos/${githubUser}/${githubRepo}/contents/${githubPath}`;

    const existing = await fetch(getUrl);
    const oldData = await existing.json();
    const sha = oldData.sha;

    const body = {
        message: "Update schedule560.json",
        content: btoa(unescape(encodeURIComponent(content))),
        sha: sha
    };

    const res = await fetch(getUrl, {
        method: "PUT",
        headers: {
            "Authorization": `token ${token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
    });

    if (res.ok) alert("Saved to GitHub!");
    else alert("Failed to save.");
}



// ---------------------- INITIAL LOAD ----------------------
loadLocal();

</script>
</body>
</html>
